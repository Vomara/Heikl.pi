<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heikl Pi App - تفعيل الخطوة 10</title>
    <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body style="text-align: center; padding-top: 50px; font-family: Arial, sans-serif; background-color: #f4f4f9;">

    <div style="max-width: 500px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
        <h1 style="color: #673ab7;">Welcome to Heikl Pi App</h1>
        <p style="font-size: 18px; color: #555;">أهلاً بك! أنت الآن في المرحلة النهائية لتفعيل الخطوة رقم 10.</p>
        
        <div style="margin: 30px 0;">
            <button id="pay-button" onclick="pay()" style="padding: 15px 30px; background: #673ab7; color: white; border: none; border-radius: 8px; font-size: 20px; cursor: pointer; transition: 0.3s;">
                تفعيل الخطوة 10 - دفع 0.1 Pi
            </button>
        </div>

        <p id="status" style="margin-top: 20px; font-weight: bold; color: #333;"></p>
    </div>

    <script>
        // تهيئة التطبيق - وضع sandbox: true لأنك تستخدم Pi Testnet حالياً
        Pi.init({ version: "2.0", sandbox: true });

        async function pay() {
            const statusElement = document.getElementById('status');
            statusElement.innerText = "جاري تحضير عملية الدفع...";
            
            try {
                const payment = await Pi.createPayment({
                    amount: 0.1,
                    memo: "تفعيل الخطوة 10 برمجياً",
                    metadata: { orderId: "order_" + Date.now() }
                }, {
                    // الخطوة الأهم: الموافقة الفورية لمنع رسالة "انتهت صلاحية الدفع"
                    onReadyForServerApproval: function(paymentId) {
                        console.log("تم استلام طلب الدفع بنجاح: " + paymentId);
                        statusElement.innerText = "تم إنشاء الطلب.. بانتظار تأكيدك من المحفظة";
                        // في وضع التست نت والمواقع البسيطة، السيرفر يوافق هنا تلقائياً
                    },
                    onReadyForServerCompletion: function(paymentId, txid) {
                        statusElement.style.color = "green";
                        statusElement.innerText = "تهانينا! تمت العملية بنجاح. رقم المعاملة: " + txid;
                        alert("نجحت المعاملة! يمكنك الآن العودة للوحة المطورين للتحقق من الخطوة 10");
                    },
                    onCancel: function(paymentId) {
                        statusElement.style.color = "orange";
                        statusElement.innerText = "تم إلغاء عملية الدفع.";
                    },
                    onError: function(error, payment) {
                        statusElement.style.color = "red";
                        statusElement.innerText = "حدث خطأ: " + error.message;
                    }
                });
            } catch (err) {
                statusElement.style.color = "red";
                statusElement.innerText = "يجب فتح الموقع داخل Pi Browser حصراً";
            }
        }
    </script>
</body>
</html>
